# CANopen电机控制上位机开发文档

## 项目概述

本项目是基于PyQt5和NimServoSDK开发的CANopen电机控制调试上位机，用于对支持CANopen协议的伺服电机进行控制和调试。应用程序提供了友好的图形用户界面，支持电机的位置控制、速度控制、状态监控以及编码器数据读取等功能。

## 功能特点

- 支持CANopen协议电机的连接和调试
- 轮廓位置模式(PP)和轮廓速度模式(PV)控制
- 刹车控制功能
- 电机状态实时监控
- 编码器数据读取与显示
- 直观的图形用户界面
- 配置文件支持，自动保存和加载设置
- 可拖动的左侧功能面板，支持用户自定义界面布局
- 类似专业CAD/CAM软件的界面布局，支持多种停靠位置
- 工具栏可拖拽至左侧或右侧，自动转换为垂直排列的按钮组

## 界面设计

界面采用现代化设计，主要特点包括：

1. **多层操作区设计**
   - 顶部工具栏：提供基本控制功能，如连接、断开、使能、脱机等操作
   - 左侧功能面板：提供快速切换标签页的功能按钮，支持拖拽定位和浮动窗口模式
   - 左侧和右侧工具栏容器：提供放置垂直工具栏的区域，支持工具栏的拖拽放置

2. **可停靠功能面板**
   - 左侧功能面板采用可停靠设计，用户可以自由拖动其位置
   - 支持悬浮模式，可放置于屏幕任意位置
   - 支持在左侧、右侧、顶部或底部停靠
   - 会自动保存用户的布局偏好，下次启动时恢复

3. **标签页布局**
   - 位置控制、速度控制、监控和编码器四个主要功能区分为不同标签页
   - 可通过左侧功能面板快速切换

4. **专业界面风格**
   - 参考专业CAD/CAM软件界面布局
   - 采用蓝色主题风格的功能按钮
   - 用户可拖拽调整界面布局，适应不同工作习惯
   - 支持将功能面板放置在左侧、右侧或顶部等多种位置

5. **智能工具栏**
   - 顶部工具栏可拖拽至左侧或右侧区域
   - 当放置在侧边时，按钮自动转换为垂直排列
   - 提供了专门的左侧和右侧空白容器区域，用于放置垂直工具栏
   - 当工具栏返回顶部时，按钮自动恢复为水平排列

## 开发进展

我们基于 NimServoSDK 开发了一个 Python 封装类 `MotorController`，用于简化基于 CANopen 协议的电机控制操作。目前已成功实现了基本的电机控制功能，包括轮廓位置模式、轮廓速度模式和刹车控制。

### 已完成功能

1. **初始化与连接**
   - SDK 初始化
   - CANopen 设备连接
   - 节点扫描和检测
   - 参数加载和配置

2. **工作模式控制**
   - 轮廓位置模式 (PP)
   - 轮廓速度模式 (PV)

3. **运动控制**
   - 位置运动控制（绝对位置、相对位置）
   - 速度运动控制（正转、反转、停止）

4. **刹车控制**
   - 释放刹车
   - 吸合刹车

5. **状态监控**
   - 电机状态获取
   - 位置和速度监控
   - 目标位置到达检测

6. **用户界面增强**
   - 可拖动的左侧功能面板
   - 自适应工具栏布局（水平/垂直自动切换）
   - 用户界面布局保存和恢复
   - 高分辨率屏幕适配优化

### 最近更新

1. **界面优化**
   - 工具栏视觉优化，采用更现代的扁平化样式
   - 将工具栏按钮改为扁平化设计，移除背景色，使用蓝色文字和浅色边框
   - 统一左侧功能面板和左侧工具栏按钮的样式，保持视觉风格一致性
   - 增加按钮内边距从12px到16px，宽度从60px到80px，提高视觉舒适度
   - 将功能选择区改为左侧可停靠功能面板，支持用户自定义位置
   - 采用专业CAD/CAM软件风格的界面布局
   - 记忆用户界面布局设置
   - 修复工具栏从左侧拖到顶部后显示不全的问题
   - 调整数值显示框高度，使其更加美观与统一
   - 优化左侧按钮样式，采用扁平化设计，移除背景色
   - 增加左侧容器宽度从150px到160px，最大宽度到180px，确保按钮显示完整
   - 增加右侧边距，从8px增加到12px，改善视觉体验
   - 位置状态中的当前位置、当前速度和目标到达状态显示在同一行
   - 设置状态显示框长度可伸缩，通过列伸缩因子(column stretch)实现
   - 将速度控制页面中的状态显示也调整为水平布局，保持风格一致性
   - 增加窗口最小宽度从1150px到1600px，确保所有控件完全显示
   - 添加右侧工具栏容器，与左侧容器对称，支持将工具栏拖拽至右侧
   - 增加状态显示框高度从40px到45px，确保角度符号完全显示不被遮挡
   - 优化编码器页面的角度显示更新机制，使界面更加流畅，只在电机运动或每5次更新时刷新UI

2. **工具栏增强**
   - 添加了左侧和右侧空白容器，用于放置工具栏按钮
   - 工具栏拖拽到左侧或右侧时自动切换为垂直布局
   - 智能检测工具栏位置和方向变化
   - 工具栏按钮在垂直模式下重新样式化，提升视觉体验
   - 优化工具栏按钮大小，确保在顶部和两侧都能完整显示所有按钮
   - 在左侧工具栏顶部添加可拖动手柄，提供与主工具栏一致的视觉设计
   - 实现拖拽功能，支持将工具栏拖回横向布局
   - 添加拖拽过程中的视觉反馈，在顶部显示半透明蓝色接收区域
   - 改进左侧工具栏按钮的交互体验，更符合现代界面设计规范
   - 修复了拖拽相关的导入错误，确保QDrag和QMimeData正确导入
   - 增强拖拽操作流畅性，通过自定义拖拽图像提供更好的视觉提示
   - 左右两侧工具栏容器可以同时使用，支持更灵活的界面布局方式

3. **界面布局增强**
   - 功能面板可拖拽到左侧、右侧、顶部或底部
   - 支持浮动模式，可自由放置在屏幕任意位置
   - 优化按钮布局和外观
   - 自动根据停靠位置调整按钮排列
   - 调整QDoubleSpinBox高度，解决显示框过高的问题
   - 统一各个标签页的状态显示风格，全部采用水平布局
   - 位置控制和速度控制标签页的状态显示区域都采用同样的设计模式
   - 设置状态标签可伸缩，使界面在调整大小时保持比例协调
   - 优化状态标签高度，适当增加以确保角度符号完全显示
   - 使用网格布局实现状态信息的单行显示，更加紧凑整齐

4. **性能优化**
   - 提高状态更新频率，从原来的20Hz提升到50Hz
   - 提高编码器数据采集频率至100Hz
   - 优化数据显示更新逻辑，减少UI卡顿
   - 改进编码器角度显示方式，采用选择性更新策略，只在电机运动或每5次更新时刷新UI
   - 将编码器数据和日志记录分离，界面以流畅为主，日志记录以高频率、高精度为主

### 测试结果

测试程序 `motor_test.py` 已经成功运行，验证了以下功能：

- 轮廓位置模式下的绝对位置和相对位置运动控制
- 轮廓速度模式下的正向和反向速度控制
- 刹车的释放和吸合操作
- 界面布局记忆功能正常工作
- 功能面板可正常拖拽并在不同位置停靠
- 工具栏可以从顶部拖至左侧或右侧，并自动切换为垂直布局
- 优化后的UI元素在各种屏幕分辨率下表现良好
- 工具栏按钮在顶部和两侧都能完整显示
- 左侧和右侧工具栏顶部的拖动手柄工作正常，可以将工具栏拖回顶部
- 状态显示区域在调整窗口大小时能保持良好的比例和布局
- 位置状态信息（当前位置、当前速度、目标到达）显示在同一行中，便于监控
- 编码器界面中角度显示更加流畅，不会频繁刷新导致界面卡顿

## 安装依赖

```bash
pip install -r requirements.txt
```

## 运行应用

```bash
python motor_qt_app.py
```

## 软件架构

上位机采用MVC (Model-View-Controller) 架构设计：

1. **模型层 (Model)**：
   - `motor_control.py`：电机控制底层接口，负责与电机进行直接通信
   - `controllers/motor_controller_wrapper.py`：电机控制器包装类，为UI层提供线程安全的控制接口

2. **视图层 (View)**：
   - `ui/main_window.py`：主窗口界面
   - `ui/connect_dialog.py`：连接配置对话框

3. **控制层 (Controller)**：
   - `main.py`：应用程序入口，负责启动和初始化

4. **项目结构**：
   ```
   motor_qt_app/           # 应用程序包
   ├── __init__.py
   ├── main.py             # 主程序入口
   ├── controllers/        # 控制器模块
   │   ├── __init__.py
   │   ├── motor_controller_wrapper.py
   │   └── encoder_controller.py
   ├── ui/                 # 界面模块
   │   ├── __init__.py
   │   ├── main_window.py
   │   └── connect_dialog.py
   └── resources/          # 资源文件
   motor_qt_app.py         # 顶层入口文件
   requirements.txt        # 依赖列表
   电机控制开发说明.md      # 项目文档
   ```

## 主要功能

1. **电机连接**：
   - 支持CANopen通信协议
   - 可配置节点ID、波特率等参数
   - 提供连接状态实时显示

2. **工作模式**：
   - 轮廓位置模式 (PP)：进行精确的位置控制
   - 轮廓速度模式 (PV)：进行连续的速度控制

3. **位置控制**：
   - 绝对位置运动：移动到指定目标位置
   - 相对位置运动：按指定距离移动
   - 可设置运动速度、加速度和减速度

4. **速度控制**：
   - 连续速度运动：按指定速度正向或反向运动
   - 提供快捷按钮进行常用速度控制
   - 可设置加速度和减速度

5. **状态监控**：
   - 实时显示电机位置、速度
   - 显示电机连接状态、使能状态等
   - 提供操作日志记录功能

6. **安全控制**：
   - 紧急停止功能
   - 暂停功能：按设定的减速度减速到0
   - 刹车控制：释放和吸合刹车

7. **编码器操作**：
   - 切换到编码器标签页可查看编码器数据
   - 查看编码器的位置值、角度值和状态信息
   - 实时数据区域显示编码器的历史数据记录

8. **界面布局**：
   - 可拖动左侧功能面板，支持停靠在左侧、右侧、顶部或底部
   - 支持功能面板浮动模式
   - 工具栏可拖拽到左侧或右侧，自动调整为垂直排列
   - 用户界面布局自动保存和恢复
   - 专业CAD/CAM风格的界面设计，操作直观

## 界面交互说明

1. **工具栏操作**：
   - 顶部工具栏可通过拖拽移动位置
   - 拖拽至左侧区域时，会自动切换为垂直排列的按钮
   - 左侧工具栏顶部有可拖动的手柄，鼠标悬停时显示手形光标
   - 通过拖动顶部手柄可将工具栏从左侧拖回顶部横向布局
   - 拖动过程中会在顶部显示接收区域，提供直观的视觉反馈
   - 所有工具栏按钮采用扁平化设计，提供更现代的外观
   - 左侧工具栏区域在未使用时不占用屏幕空间

2. **功能面板操作**：
   - 通过面板标题栏拖拽可改变位置
   - 可停靠在主窗口的四个边缘
   - 可设置为浮动模式，放置在屏幕任意位置

3. **布局保存**：
   - 关闭程序时会自动保存当前布局
   - 包括工具栏位置、功能面板位置和大小
   - 下次启动时会自动恢复上次的布局设置

## 可用方法

`MotorController` 类提供了以下方法可供调用：

### 初始化和连接

```python
# 创建电机控制实例
motor = MotorController(sdk_path="路径/到/SDK", comm_type=0, node_id=1)

# 连接CANopen设备
motor.connect_canopen(dev_type="1001", dev_index=0, baudrate=8)

# 初始化电机
motor.initialize_motor(param_db="CANopen.db", unit_factor=10000.0)
```

### 电机基本控制

```python
# 使能电机
motor.enable_motor()

# 脱机电机
motor.disable_motor()

# 设置运动参数(速度、加速度、减速度)
motor.set_motion_parameters(velocity=10.0, accel=12.5, decel=12.5)

# 快速停止
motor.quick_stop()
```

### 工作模式设置

```python
# 设置轮廓位置模式
motor.set_profile_position_mode()

# 设置轮廓速度模式
motor.set_profile_velocity_mode()
```

### 位置控制

```python
# 移动到绝对位置
motor.move_to_position(position=100.0, immediate=True)

# 相对位置移动
motor.move_by_distance(distance=10.0, immediate=True)

# 等待目标位置到达
motor.wait_target_reached(timeout=5.0, interval=0.1)

# 检查是否到达目标位置
reached = motor.check_target_reached()
```

### 速度控制

```python
# 速度运动（正负值决定方向）
motor.run_velocity(velocity=5.0)  # 正向
motor.run_velocity(velocity=-5.0) # 反向
```

## 配置文件说明

应用程序使用JSON格式的配置文件保存用户设置，主要包括以下几个部分：

1. **UI配置**
   - 窗口大小和位置
   - 当前选中的标签页
   - 左侧功能面板的位置和停靠状态
   - 工具栏位置和方向

2. **位置控制参数**
   - 速度、加速度、减速度
   - 目标位置和相对距离

3. **速度控制参数**
   - 加速度、减速度
   - 目标速度

配置文件自动保存在应用程序目录下的 `config.json` 文件中。

## 未来计划

1. **增强功能**
   - 支持更多CANopen电机工作模式
   - 添加电机参数配置和调整功能
   - 实现电机数据波形图显示
   - 增加更多功能区域的自定义布局选项

2. **界面优化**
   - 增加深色模式支持
   - 支持界面主题切换
   - 优化对不同分辨率屏幕的适配
   - 增加更多可停靠面板，支持更丰富的布局组合

3. **性能提升**
   - 优化多线程处理逻辑
   - 提高数据采集和显示效率
   - 减少资源占用
   - 增强用户界面响应速度
